{{- /* Shared types and functions for all services in a proto file */ -}}
// Common error codes used across all NATS microservices
const (
	ErrCodeInvalidArgument  = "INVALID_ARGUMENT"
	ErrCodeNotFound         = "NOT_FOUND"
	ErrCodeAlreadyExists    = "ALREADY_EXISTS"
	ErrCodePermissionDenied = "PERMISSION_DENIED"
	ErrCodeUnauthenticated  = "UNAUTHENTICATED"
	ErrCodeInternal         = "INTERNAL"
	ErrCodeUnavailable      = "UNAVAILABLE"
)

// registerConfig holds configuration for service registration
type registerConfig struct {
	name          string
	version       string
	description   string
	subjectPrefix string
	timeout       time.Duration
	metadata      map[string]string
	statsHandler  micro.StatsHandler
	doneHandler   micro.DoneHandler
	errorHandler  micro.ErrHandler
}

// RegisterOption configures the service registration
type RegisterOption func(*registerConfig)

// WithName overrides the service name from the proto definition
func WithName(name string) RegisterOption {
	return func(c *registerConfig) { c.name = name }
}

// WithVersion overrides the service version from the proto definition
func WithVersion(version string) RegisterOption {
	return func(c *registerConfig) { c.version = version }
}

// WithDescription overrides the service description from the proto definition
func WithDescription(desc string) RegisterOption {
	return func(c *registerConfig) { c.description = desc }
}

// WithSubjectPrefix overrides the subject prefix from the proto definition
func WithSubjectPrefix(prefix string) RegisterOption {
	return func(c *registerConfig) { c.subjectPrefix = prefix }
}

// WithTimeout sets the default timeout for all service methods.
// This overrides the timeout configured in the proto definition.
// Use 0 for no timeout (context.Background).
func WithTimeout(timeout time.Duration) RegisterOption {
	return func(c *registerConfig) { c.timeout = timeout }
}

// WithMetadata replaces all service metadata.
// This completely overrides metadata defined in the proto definition.
// Use WithAdditionalMetadata to merge with proto metadata instead.
func WithMetadata(metadata map[string]string) RegisterOption {
	return func(c *registerConfig) { c.metadata = metadata }
}

// WithAdditionalMetadata adds or updates metadata entries.
// This merges with metadata defined in the proto definition.
// Duplicate keys will override proto values.
func WithAdditionalMetadata(metadata map[string]string) RegisterOption {
	return func(c *registerConfig) {
		for k, v := range metadata {
			c.metadata[k] = v
		}
	}
}

// WithStatsHandler sets a callback for service statistics.
// The handler is called periodically with endpoint stats including
// request counts, error counts, and processing times.
func WithStatsHandler(handler micro.StatsHandler) RegisterOption {
	return func(c *registerConfig) { c.statsHandler = handler }
}

// WithDoneHandler sets a callback invoked when the service stops
func WithDoneHandler(handler micro.DoneHandler) RegisterOption {
	return func(c *registerConfig) { c.doneHandler = handler }
}

// WithErrorHandler sets a callback for handling service-level errors
func WithErrorHandler(handler micro.ErrHandler) RegisterOption {
	return func(c *registerConfig) { c.errorHandler = handler }
}

// natsClientConfig holds configuration for NATS clients
type natsClientConfig struct {
	subjectPrefix string
}

// NatsClientOption is a generic client configuration option
// It uses an interface to allow configuration of any client type
type NatsClientOption interface {
	applyNatsClientOption(*natsClientConfig)
}

// natsClientOptionFunc is a function adapter for NatsClientOption
type natsClientOptionFunc func(*natsClientConfig)

func (f natsClientOptionFunc) applyNatsClientOption(c *natsClientConfig) {
	f(c)
}

// WithNatsClientSubjectPrefix overrides the subject prefix for the client.
// By default, the prefix from the proto definition is used.
func WithNatsClientSubjectPrefix(prefix string) NatsClientOption {
	return natsClientOptionFunc(func(c *natsClientConfig) {
		c.subjectPrefix = prefix
	})
}

