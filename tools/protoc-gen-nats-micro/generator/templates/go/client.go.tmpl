{{- /* Client implementation */ -}}
// {{.Service.GoName}}NatsClientInterface is the interface for the NATS client
// This interface allows for easier dependency injection and testing
type {{.Service.GoName}}NatsClientInterface interface {
{{- range .Service.Methods}}
{{- $endpointOpts := GetEndpointOptions .}}
{{- if not $endpointOpts.Skip}}
  {{.GoName}}(context.Context, *{{.Input.GoIdent.GoName}}) (*{{.Output.GoIdent.GoName}}, error)
{{- end}}
{{- end}}
  Endpoints() []{{.Service.GoName}}EndpointInfo
}

// {{.Service.GoName}}NatsClient is the concrete implementation of {{.Service.GoName}}NatsClientInterface
type {{.Service.GoName}}NatsClient struct {
  nc            *nats.Conn
  subjectPrefix string
}

// New{{.Service.GoName}}NatsClient creates a new NATS client for {{.Service.GoName}}.
// The client sends requests over NATS using protobuf serialization.
func New{{.Service.GoName}}NatsClient(nc *nats.Conn, opts ...NatsClientOption) {{.Service.GoName}}NatsClientInterface {
  cfg := &natsClientConfig{
    subjectPrefix: "{{.Options.SubjectPrefix}}",
  }
  for _, opt := range opts {
    opt.applyNatsClientOption(cfg)
  }
  c := &{{.Service.GoName}}NatsClient{
    nc:            nc,
    subjectPrefix: cfg.subjectPrefix,
  }
  return c
}

{{range .Service.Methods -}}
{{- $endpointOpts := GetEndpointOptions .}}
{{- if not $endpointOpts.Skip}}
// {{.GoName}} sends a {{.GoName}} request to the service via NATS.
// Returns an error if the request fails or the service returns an error.
func (c *{{$.Service.GoName}}NatsClient) {{.GoName}}(ctx context.Context, req *{{.Input.GoIdent.GoName}}) (*{{.Output.GoIdent.GoName}}, error) {
  subject := c.subjectPrefix + ".{{ToSnakeCase .GoName}}"

  data, err := proto.Marshal(req)
  if err != nil {
    return nil, err
  }

  msg, err := c.nc.RequestWithContext(ctx, subject, data)
  if err != nil {
    return nil, err
  }

  // Check if this is an error response from the service
  if msg.Header.Get("Status") != "" {
    code := msg.Header.Get("Status")
    description := msg.Header.Get("Description")
    return nil, &{{$.Service.GoName}}Error{
      Code:    code,
      Method:  "{{.GoName}}",
      Message: description,
    }
  }

  var resp {{.Output.GoIdent.GoName}}
  if err := proto.Unmarshal(msg.Data, &resp); err != nil {
    return nil, err
  }

  return &resp, nil
}

{{end -}}
{{end -}}
// Endpoints returns information about all service endpoints this client can call.
// This is useful for debugging, monitoring, and introspection.
func (c *{{.Service.GoName}}NatsClient) Endpoints() []{{.Service.GoName}}EndpointInfo {
  return []{{.Service.GoName}}EndpointInfo{
{{- range .Service.Methods}}
{{- $endpointOpts := GetEndpointOptions .}}
{{- if not $endpointOpts.Skip}}
    {Name: "{{.GoName}}", Subject: c.subjectPrefix + ".{{ToSnakeCase .GoName}}"},
{{- end}}
{{- end}}
  }
}

