syntax = "proto3";

package natsmicro;

import "google/protobuf/descriptor.proto";
import "google/protobuf/duration.proto";

option go_package = "github.com/toyz/protoc-gen-nats-micro/gen/nats/micro";

// Service-level options for NATS microservices
message ServiceOptions {
  // The NATS subject prefix for all endpoints in this service
  // Optional: defaults to snake_case of service name (e.g., "product_service")
  string subject_prefix = 1;
  
  // Service name (optional, defaults to snake_case of service name)
  string name = 2;
  
  // Service version (optional, defaults to "1.0.0")
  string version = 3;
  
  // Service description (optional)
  string description = 4;
  
  // Service metadata (optional, key-value pairs for service discovery)
  map<string, string> metadata = 5;
  
  // Request timeout (optional, 0 means no timeout)
  // This is the default timeout for all endpoints in this service
  google.protobuf.Duration timeout = 6;
  
  // Skip code generation for this service (optional, defaults to false)
  // Set to true to exclude this service from NATS micro generation
  bool skip = 7;
  
  // Use JSON encoding instead of binary protobuf (optional, defaults to false)
  // When true, messages are marshaled/unmarshaled using protojson (human-readable)
  // When false (default), messages use binary protobuf encoding (more efficient)
  bool json = 8;
}

// Endpoint-level options for individual RPC methods
message EndpointOptions {
  // Request timeout (optional, 0 means use service default)
  // Overrides the service-level timeout for this specific endpoint
  google.protobuf.Duration timeout = 1;
  
  // Skip code generation for this endpoint (optional, defaults to false)
  // Set to true to exclude this specific endpoint from NATS micro generation
  bool skip = 2;
  
  // Endpoint metadata (optional, key-value pairs for endpoint-specific metadata)
  // This metadata is passed to the NATS micro endpoint registration
  map<string, string> metadata = 3;
}

// KV Store options for RPC methods
// When set, the server handler automatically persists the response
// into a NATS JetStream KV bucket after processing.
message KVStoreOptions {
  // KV bucket name (e.g., "user_profiles")
  string bucket = 1;

  // Key template with {field} placeholders resolved from the request message
  // e.g., "user.{id}" extracts the 'id' field from the request
  string key_template = 2;
}

// Object Store options for RPC methods
// When set, the handler stores/retrieves large binary objects
// from a NATS JetStream Object Store bucket.
message ObjectStoreOptions {
  // Object store bucket name (e.g., "firmware_binaries")
  string bucket = 1;

  // Key template with {field} placeholders (optional, defaults to method name)
  string key_template = 2;
}

// Streaming options for fine-tuning streaming RPC behavior
message StreamOptions {
  // Max concurrent in-flight messages (backpressure, 0 = unlimited)
  int32 max_inflight = 1;

  // Guarantee message ordering via sequence headers
  bool ordered = 2;
}

extend google.protobuf.ServiceOptions {
  ServiceOptions service = 50001;
}

extend google.protobuf.MethodOptions {
  EndpointOptions endpoint = 50002;
  KVStoreOptions kv_store = 50003;
  ObjectStoreOptions object_store = 50004;
  StreamOptions stream = 50005;
}
